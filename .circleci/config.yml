defaults: &defaults
  working_directory: ~/bootstrap-aws-profiles
  environment:
    BASH_ENV: env
  docker:
    - image: quay.io/feedyard/circleci-infra-agent
      auth:
        username: $QUAY_USER
        password: $QUAY_PASS

version: 2

jobs:

  plan:
    <<: *defaults

    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: confirm Docker
          command: 'docker info'
      - run:
          name: decrypt secrets
          command: 'invoke dec'
      - run:
          name: set aws credentials
          command: bash setup_profile.sh
      - run:
          name: initialize the terraform state backend
          command: invoke init
      - run:
          name: create terraform plan
          command: invoke plan

    apply:
      <<: *defaults

      steps:
        - checkout
        - setup_remote_docker
        - run:
            name: confirm Docker
            command: 'docker info'
        - run:
            name: decrypt secrets
            command: 'invoke dec'
        - run:
            name: set aws credentials
            command: |
              mkdir ~/.aws
              cat <<EOF > ~/.aws/credentials
              [bootstrap-profile]
              aws_access_key_id=$profile_access_key
              aws_secret_access_key=$profile_secret_key
              region=$profile_region
              EOF
        - run:
            name: initialize the terraform state backend
            command: invoke init
        - run:
            name: apply terraform plan
            command: invoke apply
        - run:
            name: run tests
            command: |
              AWS_PROFILE=bootstrap-profile rspec spec

  destroy:
      <<: *defaults

      steps:
        - checkout
        - setup_remote_docker
        - run:
            name: confirm Docker
            command: 'docker info'
        - run:
            name: decrypt secrets
            command: 'invoke dec'
        - run:
            name: set aws credentials
            command: |
              mkdir ~/.aws
              cat <<EOF > ~/.aws/credentials
              [bootstrap-profile]
              aws_access_key_id=$profile_access_key
              aws_secret_access_key=$profile_secret_key
              EOF
        - run:
            name: initialize the terraform state backend
            command: invoke init
        - run:
            name: delete all state configuration
            command: invoke destroy


workflows:
  version: 2
  bootstrap-aws-profile-pipeline:
    jobs:
      - plan
      - approve-plan:
         type: approval
         requires:
           -  plan
      - apply:
          requires:
            - approve-plan
      - approve-destroy:
          type: approval
          requires:
            - apply
      - destroy:
          requires:
            - approve-destroy